name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      PR_AUTHOR: ${{ github.event.pull_request.user.login }}
    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1
        with:
          app-id: ${{ secrets.REVIEW_APP_ID }}
          private-key: ${{ secrets.REVIEW_APP_PRIVATE_KEY }}

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR diff
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: gh pr diff "$PR_NUMBER" > /tmp/pr.diff

      - name: Resolve Claude auth
        id: claude-auth
        env:
          HAS_OAUTH: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN != '' }}
          HAS_APIKEY: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        run: |
          if [ "$HAS_OAUTH" = "true" ]; then
            echo "method=oauth" >> "$GITHUB_OUTPUT"
          elif [ "$HAS_APIKEY" = "true" ]; then
            echo "method=apikey" >> "$GITHUB_OUTPUT"
          else
            echo "::error::No Claude auth configured. Set CLAUDE_CODE_OAUTH_TOKEN or ANTHROPIC_API_KEY secret"
            exit 1
          fi

      - name: Build review prompt
        run: |
          {
            cat "$GITHUB_WORKSPACE/.claude/review-rules.md"
            printf '\nPR #%s: %s\nAuthor: %s\n\n' "$PR_NUMBER" "$PR_TITLE" "$PR_AUTHOR"
            cat /tmp/pr.diff
          } > /tmp/prompt.txt
          echo "Prompt size: $(wc -c < /tmp/prompt.txt) bytes"

      - name: Run Claude Code Review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AUTH_METHOD: ${{ steps.claude-auth.outputs.method }}
        run: |
          AUTH_ARGS=""
          if [ "$AUTH_METHOD" = "oauth" ]; then
            AUTH_ARGS="-e CLAUDE_CODE_OAUTH_TOKEN"
          else
            AUTH_ARGS="-e ANTHROPIC_API_KEY"
          fi

          docker run --rm \
            $AUTH_ARGS \
            -v "$GITHUB_WORKSPACE:/workspace:ro" \
            -v /tmp/prompt.txt:/tmp/prompt.txt:ro \
            -w /workspace \
            ghcr.io/kailas-cloud/claudocker:latest \
            sh -c 'cat /tmp/prompt.txt | claude -p - --output-format json --max-turns 3' \
            > /tmp/review.json

          echo "--- Review output ---"
          cat /tmp/review.json

      - name: Post review and set quality gate
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Claude --output-format json: {"type":"result","result":"<text>",...}
          # .result contains Claude's text response (should be our review JSON)
          RESULT_RAW=$(jq -r '.result // empty' /tmp/review.json)

          if [ -z "$RESULT_RAW" ]; then
            echo "::warning::Claude returned no result field. Full output:"
            cat /tmp/review.json
            VERDICT="approve"
            BODY="## Claude Code Review\n\nReview produced no structured output. Check workflow logs."
          else
            # Claude may wrap JSON in markdown fences — strip them
            CLEAN=$(echo "$RESULT_RAW" | sed '/^```/d')

            # Try to parse as JSON
            if echo "$CLEAN" | jq empty 2>/dev/null; then
              VERDICT=$(echo "$CLEAN" | jq -r '.verdict // "approve"')
              SUMMARY=$(echo "$CLEAN" | jq -r '.summary // "No summary"')
              ISSUES=$(echo "$CLEAN" | jq -r '
                if (.issues | length) > 0 then
                  "### Issues (" + (.issues | length | tostring) + ")\n\n" +
                  ([.issues[] |
                    "- **[" + (.severity | ascii_upcase) + "]** `" + .file +
                    (if .line then ":" + (.line | tostring) else "" end) +
                    "` — " + .message +
                    (if .suggestion then "\n  > " + .suggestion else "" end)
                  ] | join("\n"))
                else
                  "No issues found."
                end
              ')
              BODY=$(printf '## Claude Code Review\n\n%s\n\n%s' "$SUMMARY" "$ISSUES")
            else
              echo "::warning::Could not parse Claude output as JSON. Using raw text."
              VERDICT="approve"
              BODY=$(printf '## Claude Code Review\n\n%s' "$RESULT_RAW")
            fi
          fi

          echo "Verdict: $VERDICT"

          if [ "$VERDICT" = "request_changes" ]; then
            gh pr review "$PR_NUMBER" --request-changes --body "$BODY"
            echo "::error::Claude Review: changes requested"
            exit 1
          else
            gh pr review "$PR_NUMBER" --approve --body "$BODY"
          fi
