name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1
        with:
          app-id: ${{ secrets.REVIEW_APP_ID }}
          private-key: ${{ secrets.REVIEW_APP_PRIVATE_KEY }}

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR diff
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr.diff

      - name: Resolve Claude auth
        id: claude-auth
        env:
          HAS_OAUTH: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN != '' }}
          HAS_APIKEY: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        run: |
          if [ "$HAS_OAUTH" = "true" ]; then
            echo "method=oauth" >> "$GITHUB_OUTPUT"
          elif [ "$HAS_APIKEY" = "true" ]; then
            echo "method=apikey" >> "$GITHUB_OUTPUT"
          else
            echo "::error::No Claude auth configured. Set CLAUDE_CODE_OAUTH_TOKEN or ANTHROPIC_API_KEY secret"
            exit 1
          fi

      - name: Build review prompt
        run: |
          {
            cat "${{ github.workspace }}/.claude/review-rules.md"
            printf '\nPR #%s: %s\nAuthor: %s\n\n' \
              "${{ github.event.pull_request.number }}" \
              "${{ github.event.pull_request.title }}" \
              "${{ github.event.pull_request.user.login }}"
            cat /tmp/pr.diff
          } > /tmp/prompt.txt
          echo "Prompt size: $(wc -c < /tmp/prompt.txt) bytes"

      - name: Run Claude Code Review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AUTH_METHOD: ${{ steps.claude-auth.outputs.method }}
        run: |
          AUTH_ARGS=""
          if [ "$AUTH_METHOD" = "oauth" ]; then
            AUTH_ARGS="-e CLAUDE_CODE_OAUTH_TOKEN"
          else
            AUTH_ARGS="-e ANTHROPIC_API_KEY"
          fi

          docker run --rm \
            $AUTH_ARGS \
            -v "${{ github.workspace }}:/workspace:ro" \
            -v /tmp/prompt.txt:/tmp/prompt.txt:ro \
            -w /workspace \
            ghcr.io/kailas-cloud/claudocker:latest \
            sh -c 'claude -p "$(cat /tmp/prompt.txt)" --output-format json --max-turns 3' \
            > /tmp/review.json

          echo "--- Review output ---"
          cat /tmp/review.json

      - name: Post review and set quality gate
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Claude --output-format json wraps result in {"type":"result","result":"..."}
          # .result is a string containing our review JSON
          RESULT_RAW=$(jq -r '.result // empty' /tmp/review.json)

          if [ -z "$RESULT_RAW" ]; then
            echo "::warning::Claude returned no result. Raw output:"
            cat /tmp/review.json
            VERDICT="approve"
            SUMMARY="Review produced no output (possible max_turns or auth issue)"
            INNER='{"verdict":"approve","summary":"Review produced no output","issues":[]}'
          else
            # .result is a JSON string — parse it
            INNER=$(echo "$RESULT_RAW" | jq -r '.' 2>/dev/null || echo "$RESULT_RAW")
            VERDICT=$(echo "$INNER" | jq -r '.verdict // "approve"' 2>/dev/null || echo "approve")
            SUMMARY=$(echo "$INNER" | jq -r '.summary // "No summary"' 2>/dev/null || echo "Could not parse summary")
          fi

          echo "Verdict: $VERDICT"
          echo "Summary: $SUMMARY"

          # Build review body
          BODY=$(echo "$INNER" | jq -r '
            "## Claude Code Review\n\n" +
            (.summary // "No summary") + "\n\n" +
            if (.issues | length) > 0 then
              "### Issues (" + (.issues | length | tostring) + ")\n\n" +
              ([.issues[] |
                "- **[" + (.severity | ascii_upcase) + "]** `" + .file +
                (if .line then ":" + (.line | tostring) else "" end) +
                "` — " + .message +
                (if .suggestion then "\n  > " + .suggestion else "" end)
              ] | join("\n"))
            else
              "No issues found."
            end
          ')

          if [ "$VERDICT" = "request_changes" ]; then
            gh pr review ${{ github.event.pull_request.number }} \
              --request-changes --body "$BODY"
            echo "::error::Claude Review: changes requested"
            exit 1
          else
            gh pr review ${{ github.event.pull_request.number }} \
              --approve --body "$BODY"
          fi
