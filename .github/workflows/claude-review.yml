name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1
        with:
          app-id: ${{ secrets.REVIEW_APP_ID }}
          private-key: ${{ secrets.REVIEW_APP_PRIVATE_KEY }}

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR diff
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: gh pr diff "$PR_NUMBER" > /tmp/pr.diff

      - name: Resolve Claude auth
        id: claude-auth
        env:
          HAS_OAUTH: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN != '' }}
          HAS_APIKEY: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        run: |
          if [ "$HAS_OAUTH" = "true" ]; then
            echo "method=oauth" >> "$GITHUB_OUTPUT"
          elif [ "$HAS_APIKEY" = "true" ]; then
            echo "method=apikey" >> "$GITHUB_OUTPUT"
          else
            echo "::error::No Claude auth configured. Set CLAUDE_CODE_OAUTH_TOKEN or ANTHROPIC_API_KEY secret"
            exit 1
          fi

      - name: Build review prompt
        run: |
          {
            cat "$GITHUB_WORKSPACE/.claude/review-rules.md"
            printf '\n---\nDiff for review:\n\n'
            cat /tmp/pr.diff
          } > /tmp/prompt.txt
          echo "Prompt size: $(wc -c < /tmp/prompt.txt) bytes"

      - name: Run Claude Code Review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AUTH_METHOD: ${{ steps.claude-auth.outputs.method }}
        run: |
          AUTH_ARGS=""
          if [ "$AUTH_METHOD" = "oauth" ]; then
            AUTH_ARGS="-e CLAUDE_CODE_OAUTH_TOKEN"
          else
            AUTH_ARGS="-e ANTHROPIC_API_KEY"
          fi

          docker run --rm \
            $AUTH_ARGS \
            -v "$GITHUB_WORKSPACE:/workspace:ro" \
            -v /tmp/prompt.txt:/tmp/prompt.txt:ro \
            -w /workspace \
            ghcr.io/kailas-cloud/claudocker@sha256:b897f9eab35b85d0c4f19cfee14bb8dcfbef5fa8e9d1aa8a15da4c02922a9942 \
            sh -c 'cat /tmp/prompt.txt | claude -p - --output-format json --max-turns 3' \
            > /tmp/review.json

          echo "--- Review output ---"
          cat /tmp/review.json

      - name: Post review and set quality gate
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO: ${{ github.repository }}
        run: |
          # Claude --output-format json: {"type":"result","result":"<text>",...}
          RESULT_RAW=$(jq -r '.result // empty' /tmp/review.json)

          if [ -z "$RESULT_RAW" ]; then
            echo "::warning::Claude returned no result field. Full output:"
            cat /tmp/review.json
            # No result — skip review, don't auto-approve
            echo "::error::Review produced no output. Check workflow logs."
            exit 1
          fi

          # Claude may wrap JSON in markdown fences — strip them
          CLEAN=$(echo "$RESULT_RAW" | sed '/^```[a-z]*/d')

          if ! echo "$CLEAN" | jq empty 2>/dev/null; then
            echo "::warning::Could not parse Claude output as JSON:"
            echo "$RESULT_RAW"
            echo "::error::Review output is not valid JSON. Check workflow logs."
            exit 1
          fi

          # Save parsed review for API call
          echo "$CLEAN" > /tmp/parsed-review.json

          VERDICT=$(jq -r '.verdict' /tmp/parsed-review.json)
          SUMMARY=$(jq -r '.summary // "No summary"' /tmp/parsed-review.json)

          if [ -z "$VERDICT" ] || [ "$VERDICT" = "null" ]; then
            echo "::error::Review JSON missing verdict field"
            exit 1
          fi

          echo "Verdict: $VERDICT"
          echo "Summary: $SUMMARY"

          # Build review event
          if [ "$VERDICT" = "request_changes" ]; then
            EVENT="REQUEST_CHANGES"
          else
            EVENT="APPROVE"
          fi

          # Build inline comments from issues with file+line
          # Issues without line go into the summary body
          INLINE_COMMENTS=$(jq -c '[
            .issues // [] | .[] | select(.file and .line) |
            {
              path: .file,
              line: .line,
              body: (
                "**[" + (.severity | ascii_upcase) + "]** " + .message +
                (if .suggestion then "\n\n> **Suggestion:** " + .suggestion else "" end)
              )
            }
          ]' /tmp/parsed-review.json)

          # Build summary body with file-only issues (no line)
          BODY_ISSUES=$(jq -r '[
            .issues // [] | .[] | select(.file and (.line | not)) |
            "- **[" + (.severity | ascii_upcase) + "]** `" + .file + "` — " + .message +
            (if .suggestion then "\n  > " + .suggestion else "" end)
          ] | join("\n")' /tmp/parsed-review.json)

          BODY="## Claude Code Review\n\n${SUMMARY}"
          if [ -n "$BODY_ISSUES" ]; then
            BODY="${BODY}\n\n### General Issues\n\n${BODY_ISSUES}"
          fi

          NUM_INLINE=$(echo "$INLINE_COMMENTS" | jq 'length')
          echo "Inline comments: $NUM_INLINE"

          # Post review with inline comments via API
          jq -n \
            --arg body "$BODY" \
            --arg event "$EVENT" \
            --arg commit "${{ github.event.pull_request.head.sha }}" \
            --argjson comments "$INLINE_COMMENTS" \
            '{body: $body, event: $event, commit_id: $commit, comments: $comments}' \
          | gh api "repos/${REPO}/pulls/${PR_NUMBER}/reviews" --input -

          if [ "$VERDICT" = "request_changes" ]; then
            echo "::error::Claude Review: changes requested"
            exit 1
          fi
